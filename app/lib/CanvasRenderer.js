THREE.SpriteCanvasMaterial=function(a){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(){},this.setValues(a)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var a=new THREE.SpriteCanvasMaterial;return THREE.Material.prototype.clone.call(this,a),a.color.copy(this.color),a.program=this.program,a},THREE.CanvasRenderer=function(a){function ub(){nb.setRGB(0,0,0),ob.setRGB(0,0,0),pb.setRGB(0,0,0);for(var a=0,b=f.length;b>a;a++){var c=f[a],d=c.color;c instanceof THREE.AmbientLight?nb.add(d):c instanceof THREE.DirectionalLight?ob.add(d):c instanceof THREE.PointLight&&pb.add(d)}}function vb(a,b,c){for(var d=0,e=f.length;e>d;d++){var g=f[d];if(ab.copy(g.color),g instanceof THREE.DirectionalLight){var h=qb.setFromMatrixPosition(g.matrixWorld).normalize(),i=b.dot(h);if(0>=i)continue;i*=g.intensity,c.add(ab.multiplyScalar(i))}else if(g instanceof THREE.PointLight){var h=qb.setFromMatrixPosition(g.matrixWorld),i=b.dot(qb.subVectors(h,a).normalize());if(0>=i)continue;if(i*=0==g.distance?1:1-Math.min(a.distanceTo(h)/g.distance,1),0==i)continue;i*=g.intensity,c.add(ab.multiplyScalar(i))}}}function wb(a,b,c){Hb(c.opacity),Ib(c.blending);var d=b.scale.x*k,e=b.scale.y*l,f=.5*Math.sqrt(d*d+e*e);if(mb.min.set(a.x-f,a.y-f),mb.max.set(a.x+f,a.y+f),c instanceof THREE.SpriteMaterial){var g=c.map;if(null!==g&&void 0!==g.image){g.hasEventListener("update",Cb)===!1&&(g.image.width>0&&Db(g),g.addEventListener("update",Cb));var h=bb[g.id];void 0!==h?Nb(h):Nb("rgba( 0, 0, 0, 1 )");var i=g.image,j=i.width*g.offset.x,m=i.height*g.offset.y,n=i.width*g.repeat.x,o=i.height*g.repeat.y,p=d/n,q=e/o;r.save(),r.translate(a.x,a.y),0!==c.rotation&&r.rotate(c.rotation),r.translate(-d/2,-e/2),r.scale(p,q),r.translate(-j,-m),r.fillRect(j,m,n,o),r.restore()}else Nb(c.color.getStyle()),r.save(),r.translate(a.x,a.y),0!==c.rotation&&r.rotate(c.rotation),r.scale(d,-e),r.fillRect(-.5,-.5,1,1),r.restore()}else c instanceof THREE.SpriteCanvasMaterial&&(Mb(c.color.getStyle()),Nb(c.color.getStyle()),r.save(),r.translate(a.x,a.y),0!==c.rotation&&r.rotate(c.rotation),r.scale(d,e),c.program(r),r.restore())}function xb(a,b,c,d){if(Hb(d.opacity),Ib(d.blending),r.beginPath(),r.moveTo(a.positionScreen.x,a.positionScreen.y),r.lineTo(b.positionScreen.x,b.positionScreen.y),d instanceof THREE.LineBasicMaterial){if(Jb(d.linewidth),Kb(d.linecap),Lb(d.linejoin),d.vertexColors!==THREE.VertexColors)Mb(d.color.getStyle());else{var e=c.vertexColors[0].getStyle(),f=c.vertexColors[1].getStyle();if(e===f)Mb(e);else{try{var g=r.createLinearGradient(a.positionScreen.x,a.positionScreen.y,b.positionScreen.x,b.positionScreen.y);g.addColorStop(0,e),g.addColorStop(1,f)}catch(h){g=e}Mb(g)}}r.stroke(),mb.expandByScalar(2*d.linewidth)}else d instanceof THREE.LineDashedMaterial&&(Jb(d.linewidth),Kb(d.linecap),Lb(d.linejoin),Mb(d.color.getStyle()),Ob([d.dashSize,d.gapSize]),r.stroke(),mb.expandByScalar(2*d.linewidth),Ob([]))}function yb(a,d,e,f,g,h,i,j){if(c.info.render.vertices+=3,c.info.render.faces++,Hb(j.opacity),Ib(j.blending),J=a.positionScreen.x,K=a.positionScreen.y,L=d.positionScreen.x,M=d.positionScreen.y,N=e.positionScreen.x,O=e.positionScreen.y,zb(J,K,L,M,N,O),(j instanceof THREE.MeshLambertMaterial||j instanceof THREE.MeshPhongMaterial)&&null===j.map)$.copy(j.color),_.copy(j.emissive),j.vertexColors===THREE.FaceColors&&$.multiply(i.color),V.copy(nb),rb.copy(a.positionWorld).add(d.positionWorld).add(e.positionWorld).divideScalar(3),vb(rb,i.normalModel,V),V.multiply($).add(_),j.wireframe===!0?Ab(V,j.wireframeLinewidth,j.wireframeLinecap,j.wireframeLinejoin):Bb(V);else if(j instanceof THREE.MeshBasicMaterial||j instanceof THREE.MeshLambertMaterial||j instanceof THREE.MeshPhongMaterial)if(null!==j.map){var k=j.map.mapping;k===THREE.UVMapping&&(db=i.uvs,Eb(J,K,L,M,N,O,db[f].x,db[f].y,db[g].x,db[g].y,db[h].x,db[h].y,j.map))}else null!==j.envMap?j.envMap.mapping===THREE.SphericalReflectionMapping&&(sb.copy(i.vertexNormalsModel[f]).applyMatrix3(tb),eb=.5*sb.x+.5,fb=.5*sb.y+.5,sb.copy(i.vertexNormalsModel[g]).applyMatrix3(tb),gb=.5*sb.x+.5,hb=.5*sb.y+.5,sb.copy(i.vertexNormalsModel[h]).applyMatrix3(tb),ib=.5*sb.x+.5,jb=.5*sb.y+.5,Eb(J,K,L,M,N,O,eb,fb,gb,hb,ib,jb,j.envMap)):(V.copy(j.color),j.vertexColors===THREE.FaceColors&&V.multiply(i.color),j.wireframe===!0?Ab(V,j.wireframeLinewidth,j.wireframeLinecap,j.wireframeLinejoin):Bb(V));else j instanceof THREE.MeshDepthMaterial?(V.r=V.g=V.b=1-b(a.positionScreen.z*a.positionScreen.w,C.near,C.far),j.wireframe===!0?Ab(V,j.wireframeLinewidth,j.wireframeLinecap,j.wireframeLinejoin):Bb(V)):j instanceof THREE.MeshNormalMaterial?(sb.copy(i.normalModel).applyMatrix3(tb),V.setRGB(sb.x,sb.y,sb.z).multiplyScalar(.5).addScalar(.5),j.wireframe===!0?Ab(V,j.wireframeLinewidth,j.wireframeLinecap,j.wireframeLinejoin):Bb(V)):(V.setRGB(1,1,1),j.wireframe===!0?Ab(V,j.wireframeLinewidth,j.wireframeLinecap,j.wireframeLinejoin):Bb(V))}function zb(a,b,c,d,e,f){r.beginPath(),r.moveTo(a,b),r.lineTo(c,d),r.lineTo(e,f),r.closePath()}function Ab(a,b,c,d){Jb(b),Kb(c),Lb(d),Mb(a.getStyle()),r.stroke(),mb.expandByScalar(2*b)}function Bb(a){Nb(a.getStyle()),r.fill()}function Cb(a){Db(a.target)}function Db(a){if(!(a instanceof THREE.CompressedTexture)){var b=a.wrapS===THREE.RepeatWrapping,c=a.wrapT===THREE.RepeatWrapping,d=a.image,e=document.createElement("canvas");e.width=d.width,e.height=d.height;var f=e.getContext("2d");f.setTransform(1,0,0,-1,0,d.height),f.drawImage(d,0,0),bb[a.id]=r.createPattern(e,b===!0&&c===!0?"repeat":b===!0&&c===!1?"repeat-x":b===!1&&c===!0?"repeat-y":"no-repeat")}}function Eb(a,b,c,d,e,f,g,h,i,j,k,l,m){if(!(m instanceof THREE.DataTexture)){m.hasEventListener("update",Cb)===!1&&(void 0!==m.image&&m.image.width>0&&Db(m),m.addEventListener("update",Cb));var n=bb[m.id];if(void 0===n)return Nb("rgba(0,0,0,1)"),r.fill(),void 0;Nb(n);var o,p,q,s,t,u,v,w,x=m.offset.x/m.repeat.x,y=m.offset.y/m.repeat.y,z=m.image.width*m.repeat.x,A=m.image.height*m.repeat.y;g=(g+x)*z,h=(h+y)*A,i=(i+x)*z,j=(j+y)*A,k=(k+x)*z,l=(l+y)*A,c-=a,d-=b,e-=a,f-=b,i-=g,j-=h,k-=g,l-=h,v=i*l-k*j,0!==v&&(w=1/v,o=(l*c-j*e)*w,p=(l*d-j*f)*w,q=(i*e-k*c)*w,s=(i*f-k*d)*w,t=a-o*g-q*h,u=b-p*g-s*h,r.save(),r.transform(o,p,q,s,t,u),r.fill(),r.restore())}}function Gb(a,b,c){var g,d=b.x-a.x,e=b.y-a.y,f=d*d+e*e;0!==f&&(g=c/Math.sqrt(f),d*=g,e*=g,b.x+=d,b.y+=e,a.x-=d,a.y-=e)}function Hb(a){u!==a&&(r.globalAlpha=a,u=a)}function Ib(a){v!==a&&(a===THREE.NormalBlending?r.globalCompositeOperation="source-over":a===THREE.AdditiveBlending?r.globalCompositeOperation="lighter":a===THREE.SubtractiveBlending&&(r.globalCompositeOperation="darker"),v=a)}function Jb(a){y!==a&&(r.lineWidth=a,y=a)}function Kb(a){z!==a&&(r.lineCap=a,z=a)}function Lb(a){A!==a&&(r.lineJoin=a,A=a)}function Mb(a){w!==a&&(r.strokeStyle=a,w=a)}function Nb(a){x!==a&&(r.fillStyle=a,x=a)}function Ob(a){B.length!==a.length&&(r.setLineDash(a),B=a)}console.log("THREE.CanvasRenderer",THREE.REVISION);var b=THREE.Math.smoothstep;a=a||{};var d,e,f,C,D,E,F,J,K,L,M,N,O,db,eb,fb,gb,hb,ib,jb,c=this,g=new THREE.Projector,h=void 0!==a.canvas?a.canvas:document.createElement("canvas"),i=h.width,j=h.height,k=Math.floor(i/2),l=Math.floor(j/2),m=0,n=0,o=i,p=j,q=1,r=h.getContext("2d",{alpha:a.alpha===!0}),s=new THREE.Color(0),t=a.alpha===!0?0:1,u=1,v=0,w=null,x=null,y=null,z=null,A=null,B=[],V=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),$=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),_=new THREE.Color,ab=new THREE.Color,bb={},kb=new THREE.Box2,lb=new THREE.Box2,mb=new THREE.Box2,nb=new THREE.Color,ob=new THREE.Color,pb=new THREE.Color,qb=new THREE.Vector3,rb=new THREE.Vector3,sb=new THREE.Vector3,tb=new THREE.Matrix3;void 0===r.setLineDash&&(r.setLineDash=function(){}),this.domElement=h,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getPixelRatio=function(){return q},this.setPixelRatio=function(a){q=a},this.setSize=function(a,b,c){i=a*q,j=b*q,h.width=i,h.height=j,k=Math.floor(i/2),l=Math.floor(j/2),c!==!1&&(h.style.width=a+"px",h.style.height=b+"px"),kb.min.set(-k,-l),kb.max.set(k,l),lb.min.set(-k,-l),lb.max.set(k,l),u=1,v=0,w=null,x=null,y=null,z=null,A=null,this.setViewport(0,0,a,b)},this.setViewport=function(a,b,c,d){m=a*q,n=b*q,o=c*q,p=d*q},this.setScissor=function(){},this.enableScissorTest=function(){},this.setClearColor=function(a,b){s.set(a),t=void 0!==b?b:1,lb.min.set(-k,-l),lb.max.set(k,l)},this.setClearColorHex=function(a,b){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(a,b)},this.getClearColor=function(){return s},this.getClearAlpha=function(){return t},this.getMaxAnisotropy=function(){return 0},this.clear=function(){lb.empty()===!1&&(lb.intersect(kb),lb.expandByScalar(2),lb.min.x=lb.min.x+k,lb.min.y=-lb.min.y+l,lb.max.x=lb.max.x+k,lb.max.y=-lb.max.y+l,1>t&&r.clearRect(0|lb.min.x,0|lb.max.y,0|lb.max.x-lb.min.x,0|lb.min.y-lb.max.y),t>0&&(Ib(THREE.NormalBlending),Hb(1),Nb("rgba("+Math.floor(255*s.r)+","+Math.floor(255*s.g)+","+Math.floor(255*s.b)+","+t+")"),r.fillRect(0|lb.min.x,0|lb.max.y,0|lb.max.x-lb.min.x,0|lb.min.y-lb.max.y)),lb.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(a,b){if(b instanceof THREE.Camera==!1)return console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera."),void 0;this.autoClear===!0&&this.clear(),c.info.render.vertices=0,c.info.render.faces=0,r.setTransform(o/i,0,0,-p/j,m,j-n),r.translate(k,l),d=g.projectScene(a,b,this.sortObjects,this.sortElements),e=d.elements,f=d.lights,C=b,tb.getNormalMatrix(b.matrixWorldInverse),ub();for(var h=0,q=e.length;q>h;h++){var s=e[h],t=s.material;if(void 0!==t&&0!==t.opacity){if(mb.makeEmpty(),s instanceof THREE.RenderableSprite)D=s,D.x*=k,D.y*=l,wb(D,s,t);else if(s instanceof THREE.RenderableLine)D=s.v1,E=s.v2,D.positionScreen.x*=k,D.positionScreen.y*=l,E.positionScreen.x*=k,E.positionScreen.y*=l,mb.setFromPoints([D.positionScreen,E.positionScreen]),kb.isIntersectionBox(mb)===!0&&xb(D,E,s,t);else if(s instanceof THREE.RenderableFace){if(D=s.v1,E=s.v2,F=s.v3,D.positionScreen.z<-1||D.positionScreen.z>1)continue;if(E.positionScreen.z<-1||E.positionScreen.z>1)continue;if(F.positionScreen.z<-1||F.positionScreen.z>1)continue;D.positionScreen.x*=k,D.positionScreen.y*=l,E.positionScreen.x*=k,E.positionScreen.y*=l,F.positionScreen.x*=k,F.positionScreen.y*=l,t.overdraw>0&&(Gb(D.positionScreen,E.positionScreen,t.overdraw),Gb(E.positionScreen,F.positionScreen,t.overdraw),Gb(F.positionScreen,D.positionScreen,t.overdraw)),mb.setFromPoints([D.positionScreen,E.positionScreen,F.positionScreen]),kb.isIntersectionBox(mb)===!0&&yb(D,E,F,0,1,2,s,t)}lb.union(mb)}}r.setTransform(1,0,0,1,0,0)}};